JS.Test=new JS.Module('Test',{extend:{Unit:new JS.Module({extend:{AssertionFailedError:new JS.Class(Error,{initialize:function(a){this.message=a.toString()}})}})}});JS.Test.Unit.extend({Util:new JS.Module({extend:{Observable:new JS.Module({extend:{NOTHING:{}},addListener:function(a,b,c){if(b===undefined)throw new Error('No callback was passed as a listener');this.channels()[a]=this.channels()[a]||[];this.channels()[a].push([b,c]);return b},removeListener:function(a,b,c){var d=this.channels()[a];if(!d)return;var f=d.length;while(f--){if(d[f][0]===b){d.splice(f,1);return b}}return null},notifyListeners:function(a,b){var b=JS.array(arguments),a=b.shift(),c=this.channels()[a];if(!c)return 0;for(var d=0,f=c.length;d<f;d++)c[d][0].apply(c[d][1]||null,b);return c.length},channels:function(){return this.__channels__=this.__channels__||[]}})}})});JS.Test.Unit.extend({Assertions:new JS.Module({assertBlock:function(a,b,c){if(typeof a==='function'){c=b;b=a;a=null}this.__wrapAssertion__(function(){if(!b.call(c||null)){a=this.buildMessage(a||'assertBlock failed.');throw new JS.Test.Unit.AssertionFailedError(a);}})},flunk:function(a){this.assertBlock(this.buildMessage(a||'Flunked'),function(){return false})},assert:function(a,b){this.__wrapAssertion__(function(){this.assertBlock(this.buildMessage(b,"<?> is not true.",a),function(){return a})})},assertEqual:function(a,b,c){var d=this.buildMessage(c,"<?> expected but was\n<?>.",a,b);this.assertBlock(d,function(){return JS.Enumerable.areEqual(a,b)})},assertNotEqual:function(a,b,c){var d=this.buildMessage(c,"<?> expected not to be equal to\n<?>.",a,b);this.assertBlock(d,function(){return!JS.Enumerable.areEqual(a,b)})},assertNull:function(a,b){this.assertEqual(null,a,b)},assertNotNull:function(a,b){var c=this.buildMessage(b,"<?> expected not to be null.",a);this.assertBlock(c,function(){return a!==null})},assertKindOf:function(c,d,f){this.__wrapAssertion__(function(){var a=(!d||typeof c==='string')?typeof d:(d.klass||d.constructor);var b=this.buildMessage(f,"<?> expected to be an instance of\n<?> but was\n<?>.",d,c,a);this.assertBlock(b,function(){return JS.isType(d,c)})})},assertRespondTo:function(c,d,f){this.__wrapAssertion__(function(){var a=this.buildMessage('',"<?>\ngiven as the method name argument to #assertRespondTo must be a String.",d);this.assertBlock(a,function(){return typeof d==='string'});var b=c?c.constructor:typeof c;a=this.buildMessage(f,"<?>\nof type <?>\nexpected to respond to <?>.",c,b,d);this.assertBlock(a,function(){return c&&c[d]!==undefined})})},assertMatch:function(b,c,d){this.__wrapAssertion__(function(){var a=this.buildMessage(d,"<?> expected to match\n<?>.",c,b);this.assertBlock(a,function(){return JS.match(b,c)})})},assertNoMatch:function(b,c,d){this.__wrapAssertion__(function(){var a=this.buildMessage(d,"<?> expected not to match\n<?>.",c,b);this.assertBlock(a,function(){return(typeof b.test==='function')?!b.test(c):!b.match(c)})})},assertSame:function(a,b,c){var d=this.buildMessage(c,"<?> expected to be the same as\n<?>.",a,b);this.assertBlock(d,function(){return b===a})},assertNotSame:function(a,b,c){var d=this.buildMessage(c,"<?> expected not to be the same as\n<?>.",a,b);this.assertBlock(d,function(){return b!==a})},assertInDelta:function(b,c,d,f){this.__wrapAssertion__(function(){this.assertKindOf('number',b);this.assertKindOf('number',c);this.assertKindOf('number',d);this.assert(d>=0,"The delta should not be negative");var a=this.buildMessage(f,"<?> and\n<?> expected to be within\n<?> of each other.",b,c,d);this.assertBlock(a,function(){return Math.abs(b-c)<=d})})},assertSend:function(b,c){this.__wrapAssertion__(function(){this.assertKindOf(Array,b,"assertSend requires an array of send information");this.assert(b.length>=2,"assertSend requires at least a receiver and a message name");var a=this.buildMessage(c,"<?> expected to respond to\n<?(?)> with a true value.",b[0],JS.Test.Unit.AssertionMessage.literal(b[1]),b.slice(2));this.assertBlock(a,function(){return b[0][b[1]].apply(b[0],b.slice(2))})})},__processExceptionArgs__:function(a){var a=JS.array(a),b=(typeof a[a.length-1]==='function')?null:a.pop(),c=a.pop(),d=JS.isType(a[a.length-1],'string')?a.pop():'',f=new JS.Enumerable.Collection(a);return[a,f,d,c,b]},assertThrow:function(){var d=this.__processExceptionArgs__(arguments),f=d[0],g=d[1],h=d[2],i=d[3],j=d[4];this.__wrapAssertion__(function(){var b=this.buildMessage(h,"<?> exception expected but none was thrown.",f),c;this.assertBlock(b,function(){try{i.call(j)}catch(e){c=e;return true}return false});b=this.buildMessage(h,"<?> exception expected but was\n?",f,c);this.assertBlock(b,function(){return g.any(function(a){return JS.isType(c,a)||(c.name&&c.name===a.name)})})})},assertThrows:function(){return this.assertThrow.apply(this,arguments)},assertNothingThrown:function(){var a=this.__processExceptionArgs__(arguments),b=a[0],c=a[1],d=a[2],f=a[3],g=a[4];this.__wrapAssertion__(function(){try{f.call(g)}catch(e){if((b.length===0&&!JS.isType(e,JS.Test.Unit.AssertionFailedError))||c.any(function(type){return JS.isType(e,type)}))this.assertBlock(this.buildMessage(d,"Exception thrown:\n?",e),function(){return false});else throw e;}})},buildMessage:function(){var a=JS.array(arguments),b=a.shift(),c=a.shift();return new JS.Test.Unit.AssertionMessage(b,c,a)},__wrapAssertion__:function(a){if(this.__assertionWrapped__===undefined)this.__assertionWrapped__=false;if(!this.__assertionWrapped__){this.__assertionWrapped__=true;try{this.addAssertion();return a.call(this)}finally{this.__assertionWrapped__=false}}else{return a.call(this)}},addAssertion:function(){}})});JS.Test.Unit.extend({AssertionMessage:new JS.Class({extend:{Literal:new JS.Class({initialize:function(a){this._18=a;this.toString=this.inspect},inspect:function(){return this._18.toString()}}),literal:function(a){return new this.Literal(a)},Template:new JS.Class({extend:{create:function(a){var b=a?a.match(/\(\?\)|(?=[^\\])\?|(?:(?!\(\?\))(?:\\\?|[^\?]))+/g):[];return new this(b)}},initialize:function(b){this._S=new JS.Enumerable.Collection(b);this.count=this._S.findAll(function(a){return a==='?'||a==='(?)'}).length},result:function(b){if(b.length!==this.count)throw"The number of parameters does not match the number of substitutions.";var c=JS.array(b);return this._S.collect(function(a){if(a==='(?)')return c.shift().replace(/^\[/,'(').replace(/\]$/,')');if(a==='?')return c.shift();return a.replace(/\\\?/g,'?')}).join('')}})},initialize:function(a,b,c){this._T=a;this._19=b;this._1a=new JS.Enumerable.Collection(c)},template:function(){return this._1b=this._1b||this.klass.Template.create(this._19)},addPeriod:function(a){return/\.$/.test(a)?a:a+'.'},toString:function(){var b=[],c,d;if(this._T)b.push(this.addPeriod(this._T));d=this.template().result(this._1a.collect(function(a){return JS.Console.convert(a)},this));if(d!=='')b.push(d);return b.join("\n")}})});JS.Test.Unit.extend({Failure:new JS.Class({extend:{SINGLE_CHARACTER:'F'},initialize:function(a,b){this._j=a;this._U=b},singleCharacterDisplay:function(){return this.klass.SINGLE_CHARACTER},shortDisplay:function(){return this._j+': '+this._U.split("\n")[0]},longDisplay:function(){return"Failure:\n"+this._j+":\n"+this._U},toString:function(){return this.longDisplay()}})});JS.Test.Unit.extend({Error:new JS.Class({extend:{SINGLE_CHARACTER:'E'},initialize:function(a,b){this._j=a;this._k=b},singleCharacterDisplay:function(){return this.klass.SINGLE_CHARACTER},message:function(){return this._k.name+': '+this._k.message},shortDisplay:function(){return this._j+': '+this.message().split("\n")[0]},longDisplay:function(){return"Error:\n"+this._j+":\n"+this.message()},toString:function(){return this.longDisplay()}})});JS.Test.Unit.extend({TestResult:new JS.Class({include:JS.Test.Unit.Util.Observable,extend:{CHANGED:'CHANGED',FAULT:'FAULT'},initialize:function(){this._V=this._W=0;this._b=[];this._l=[]},addRun:function(){this._V+=1;this.notifyListeners(this.klass.CHANGED,this)},addFailure:function(a){this._b.push(a);this.notifyListeners(this.klass.FAULT,a);this.notifyListeners(this.klass.CHANGED,this)},addError:function(a){this._l.push(a);this.notifyListeners(this.klass.FAULT,a);this.notifyListeners(this.klass.CHANGED,this)},addAssertion:function(){this._W+=1;this.notifyListeners(this.klass.CHANGED,this)},toString:function(){return this.runCount()+' tests, '+this.assertionCount()+' assertions, '+this.failureCount()+' failures, '+this.errorCount()+' errors'},passed:function(){return this._b.length===0&&this._l.length===0},runCount:function(){return this._V},assertionCount:function(){return this._W},failureCount:function(){return this._b.length},errorCount:function(){return this._l.length}})});JS.Test.Unit.extend({TestSuite:new JS.Class({include:JS.Enumerable,extend:{STARTED:'Test.Unit.TestSuite.STARTED',FINISHED:'Test.Unit.TestSuite.FINISHED',forEach:function(a,b,c,d){var f=false,g=a.length,h=-1,i=0,j=this.setTimeout;var k=function(){i+=1;if(JS.Console.BROWSER)j(m,1);else l()};var l=function(){if(f)return;f=true;while(i>0)m();f=false};var m=function(){h+=1;i-=1;if(h===g)return c&&c.call(d||null);b.call(d||null,a[h],k)};k()},setTimeout:(function(){return(typeof setTimeout==='undefined')?undefined:setTimeout})()},initialize:function(a){this._m=a||'Unnamed TestSuite';this._3=[]},forEach:function(a,b,c){this.klass.forEach(this._3,a,b,c)},run:function(c,d,f,g){f.call(g||null,this.klass.STARTED,this._m);this.forEach(function(a,b){a.run(c,b,f,g)},function(){f.call(g||null,this.klass.FINISHED,this._m);d.call(g||null)},this)},push:function(a){this._3.push(a);return this},remove:function(a){var b=this._3.length;while(b--){if(this._3[b]===a)this._3.splice(b,1)}},size:function(){var a=0,b=this._3.length;while(b--){a+=this._3[b].size()}return a},empty:function(){return this._3.length===0},toString:function(){return this._m}})});JS.Test.Unit.extend({TestCase:new JS.Class({include:JS.Test.Unit.Assertions,extend:[JS.Enumerable,{testCases:[],reports:[],clear:function(){this.testCases=[]},inherited:function(a){this.testCases.push(a)},forEach:function(a,b){for(var c=0,d=this.testCases.length;c<d;c++)a.call(b||null,this.testCases[c])},STARTED:'Test.Unit.TestCase.STARTED',FINISHED:'Test.Unit.TestCase.FINISHED',suite:function(){var b=new JS.Enumerable.Collection(this.instanceMethods()),c=b.select(function(a){return/^test./.test(a)}).sort(),d=new JS.Test.Unit.TestSuite(this.displayName);for(var f=0,g=c.length;f<g;f++){try{d.push(new this(c[f]))}catch(e){}}if(d.empty()){try{d.push(new this('defaultTest'))}catch(e){}}return d}}],initialize:function(a){if(typeof this[a]!=='function')throw'invalid_test';this._1=a;this._s=true},run:function(a,b,c,d){c.call(d||null,this.klass.STARTED,this);this._2=a;var f=function(){this.exec('teardown',function(){this.exec(function(){JS.Test.Unit.mocking.verify()},function(){a.addRun();c.call(d||null,this.klass.FINISHED,this);b()})})};this.exec('setup',function(){this.exec(this._1,f)},f)},exec:function(b,c,d){if(!b)return c.call(this);if(!d)d=c;var f=(typeof b==='function')?b.length:this.__eigen__().instanceMethod(b).arity,g=(typeof b==='function')?b:this[b],h=this;if(f===0)return this._X(function(){g.call(this);c.call(this)},this.processError(d));this._X(function(){g.call(this,function(a){h.exec(a,c,d)})},this.processError(d))},processError:function(b){return function(a){if(JS.isType(a,JS.Test.Unit.AssertionFailedError))this.addFailure(a.message);else this.addError(a);if(b)b.call(this)}},_X:function(a,b,c){try{a.call(this)}catch(e){if(b)b.call(this,e)}finally{if(c)c.call(this)}},setup:function(a){a()},teardown:function(a){a()},defaultTest:function(){return this.flunk('No tests were specified')},passed:function(){return this._s},size:function(){return 1},addAssertion:function(){this._2.addAssertion()},addFailure:function(a){this._s=false;this._2.addFailure(new JS.Test.Unit.Failure(this.name(),a))},addError:function(a){this._s=false;this._2.addError(new JS.Test.Unit.Error(this.name(),a))},name:function(){var a=this._1.replace(/^test\W*/ig,'');if(a.replace(this.klass.displayName,'')===a)return this._1+'('+this.klass.displayName+')';else return a},toString:function(){return this.name()}})});JS.Test.Unit.extend({UI:new JS.Module({extend:{SILENT:1,PROGRESS_ONLY:2,NORMAL:3,VERBOSE:4,TestRunnerUtilities:new JS.Module({run:function(a,b){return new this(a,b||JS.Test.Unit.UI.NORMAL).start()}})}})});JS.Test.Unit.UI.extend({TestRunnerMediator:new JS.Class({extend:{RESET:'Test.Unit.UI.TestRunnerMediator.RESET',STARTED:'Test.Unit.UI.TestRunnerMediator.STARTED',FINISHED:'Test.Unit.UI.TestRunnerMediator.FINISHED'},include:JS.Test.Unit.Util.Observable,initialize:function(a){this._5=a},runSuite:function(f,g){var h=new Date().getTime();this.notifyListeners(this.klass.RESET,this._5.size());var i=this.createResult();this.notifyListeners(this.klass.STARTED,i);var j=JS.bind(function(){i.removeListener(JS.Test.Unit.TestResult.FAULT,l);i.removeListener(JS.Test.Unit.TestResult.CHANGED,k);var a=new Date().getTime(),b=(a-h)/1000;this.notifyListeners(this.klass.FINISHED,b);var c=JS.Test.Unit.TestCase.reports,d=c.length;while(d--)c[d].report();JS.Test.Unit.TestCase.reports=[];if(f)f.call(g||null,i)},this);var k=i.addListener(JS.Test.Unit.TestResult.CHANGED,function(a){this.notifyListeners(JS.Test.Unit.TestResult.CHANGED,a)},this);var l=i.addListener(JS.Test.Unit.TestResult.FAULT,function(a){this.notifyListeners(JS.Test.Unit.TestResult.FAULT,a)},this);this._5.run(i,j,function(a,b){this.notifyListeners(a,b)},this)},createResult:function(){return new JS.Test.Unit.TestResult()}})});JS.Test.Unit.UI.extend({Console:new JS.Module({extend:{TestRunner:new JS.Class({extend:JS.Test.Unit.UI.TestRunnerUtilities,include:JS.Console,initialize:function(a,b){this._5=(typeof a.suite==='function')?a.suite():a;this._1c=b||JS.Test.Unit.UI.NORMAL;this._t=false;this._9=[]},start:function(){this._u();this._v();return this._w()},_u:function(){this._0=this._x(this._5);var a=this._5.toString();if(JS.isType(this._5,JS.Module))a=this._5.displayName;this.consoleFormat('bold');this._c('Loaded suite '+a)},_x:function(a){return new JS.Test.Unit.UI.TestRunnerMediator(a)},_v:function(){this._0.addListener(JS.Test.Unit.TestResult.FAULT,this.method('_y'));this._0.addListener(JS.Test.Unit.UI.TestRunnerMediator.STARTED,this.method('_z'));this._0.addListener(JS.Test.Unit.UI.TestRunnerMediator.FINISHED,this.method('_A'));this._0.addListener(JS.Test.Unit.TestCase.STARTED,this.method('_B'));this._0.addListener(JS.Test.Unit.TestCase.FINISHED,this.method('_C'))},_w:function(){return this._0.runSuite()},_y:function(a){this._9.push(a);this.consoleFormat('bold','red');this._D(a.singleCharacterDisplay(),JS.Test.Unit.UI.PROGRESS_ONLY);this.reset();this._t=true},_z:function(a){this._2=a;this._n();this.reset();this._c('Started')},_A:function(a){this._n();this.reset();this._c('Finished in '+a+' seconds.');for(var b=0,c=this._9.length;b<c;b++){this._n();var d=this._9[b].longDisplay(),f=d.split('\n'),g=f.shift(),h=f.shift(),i;this.consoleFormat('bold','red');this._c((b+1)+') '+g);this._c(h);this.reset();while(i=f.shift())this.puts(i)}this._n();this.consoleFormat('bold');this._c(this._2,JS.Test.Unit.UI.PROGRESS_ONLY);this.reset()},_B:function(a){this._D(a.name()+': ',JS.Test.Unit.UI.VERBOSE)},_C:function(a){this.consoleFormat('bold','green');if(!this._t)this._D('.',JS.Test.Unit.UI.PROGRESS_ONLY);this.reset();this._n(JS.Test.Unit.UI.VERBOSE);this._t=false},_n:function(a){this._c('',a||JS.Test.Unit.UI.NORMAL)},_c:function(a,b){if(!this._Y(b||JS.Test.Unit.UI.NORMAL))return;this.puts(a)},_D:function(a,b){if(!this._Y(b||JS.Test.Unit.UI.NORMAL))return;this.print(a)},_Y:function(a){return a<=this._1c}})}})});JS.Test.Unit.UI.extend({Browser:new JS.Module({extend:{TestRunner:new JS.Class({extend:JS.Test.Unit.UI.TestRunnerUtilities,initialize:function(a,b){this._5=(typeof a.suite==='function')?a.suite():a;this._9=[];this._6()},_6:function(){return this._1d=this._1d||this.klass.Display.getInstance()},start:function(){this._u();this._v();return this._w()},_u:function(){this._0=this._x(this._5)},_x:function(a){return new JS.Test.Unit.UI.TestRunnerMediator(a)},_v:function(){this._0.addListener(JS.Test.Unit.TestResult.CHANGED,this.method('_1e'));this._0.addListener(JS.Test.Unit.TestResult.FAULT,this.method('_y'));this._0.addListener(JS.Test.Unit.UI.TestRunnerMediator.STARTED,this.method('_z'));this._0.addListener(JS.Test.Unit.UI.TestRunnerMediator.FINISHED,this.method('_A'));this._0.addListener(JS.Test.Unit.TestCase.STARTED,this.method('_B'));this._0.addListener(JS.Test.Unit.TestCase.FINISHED,this.method('_C'));if(!window.TestSwarm)return;TestSwarm.serialize=this.method('toHTML');this._0.addListener(JS.Test.Unit.TestCase.FINISHED,TestSwarm.heartbeat);this._0.addListener(JS.Test.Unit.UI.TestRunnerMediator.FINISHED,function(){TestSwarm.submit({fail:this._2.failureCount(),error:this._2.errorCount(),total:this._2.runCount()})},this)},_w:function(){return this._0.runSuite()},_1e:function(){this._6().setTestCount(this._2.runCount());this._6().setAssertionCount(this._2.assertionCount());this._6().setFailureCount(this._2.failureCount());this._6().setErrorCount(this._2.errorCount())},_y:function(a){this._9.push(a);this._6().addFault(this._1f,a)},_z:function(a){this._2=a},_A:function(a){this._6().printSummary(a)},_B:function(a){this._1f=a;this._6().addTestCase(a)},_C:function(a){this._6().finishTestCase(a)},toHTML:function(){var a='<h4>'+navigator.userAgent+'</h4>';if(this._9.length>0){a+='<ul>';for(var b=0,c=this._9.length;b<c;b++){a+='<li>'+this._9[b].longDisplay().replace(/[\r\n]/g,'<br>')+'</li>'}a+='</ul>'}a+='<p>'+this._2.toString()+'</p>';return a}})}})});JS.Test.Unit.UI.Browser.TestRunner.extend({Display:new JS.Class({extend:{getInstance:function(){return this._1g=this._1g||new this()},Context:new JS.Class({initialize:function(a,b,c){this._d=b;this._a=a;this._E=[];if(c===undefined){this._F=b;return}this._G(c)},_G:function(f){var g=this,h=this._d._F||this._d,i={_3:'T',_b:'F'};this._H=new JS.DOM.Builder(h).li({className:this._a+' passed closed'},function(d){d.ul({className:'stats'},function(b){for(var c in i)b.li(function(a){a.span({className:'letter'},i[c]+': ');g[c]=a.span({className:'number'},'0')})});if(f)g._Z=d.p({className:g._a+'-name'},f);g._F=d.ul({className:'children'})});JS.DOM.Event.on(this._Z,'click',function(){JS.DOM.toggleClass(this._H,'closed')},this)},child:function(a){return this._E[a]=this._E[a]||new this.klass('spec',this,a)},addTest:function(a){var b=this._E[a]=new this.klass('test',this,a);b.ping('_3')},addFault:function(g){var h=JS.DOM.li({className:'fault'},function(f){f.p(function(a){var b=g.split(/[\r\n]+/);b.splice(1,1);for(var c=0,d=b.length;c<d;c++){if(c>0)a.br();a.concat(b[c])}})});this._F.appendChild(h);this.ping('_b');this.fail()},ping:function(a){if(!this[a])return;this[a].innerHTML=parseInt(this[a].innerHTML)+1;if(this._d.ping)this._d.ping(a)},fail:function(){if(!this._H)return;JS.DOM.removeClass(this._H,'passed');JS.DOM.addClass(this._Z,'failed');if(this._d.fail)this._d.fail()}})},initialize:function(){this._G();document.body.insertBefore(this._1h,document.body.firstChild)},_G:function(){var f=this;f._1h=JS.DOM.div({className:'test-result-container'},function(d){d.table({className:'report'},function(c){c.thead(function(b){b.tr(function(a){a.th({scope:'col'},'Tests');a.th({scope:'col'},'Assertions');a.th({scope:'col'},'Failures');a.th({scope:'col'},'Errors')})});c.tbody(function(b){b.tr(function(a){f._3=a.td();f._1i=a.td();f._b=a.td();f._l=a.td()})})});f._1j=new f.klass.Context('spec',d.ul({className:'specs'}));f._1k=d.p({className:'summary'})})},setTestCount:function(a){this._3.innerHTML=String(a)},setAssertionCount:function(a){this._1i.innerHTML=String(a)},setFailureCount:function(a){this._b.innerHTML=String(a)},setErrorCount:function(a){this._l.innerHTML=String(a)},addTestCase:function(a){var b=this._10(a),c=b.name,d=b.context;d.addTest(c)},finishTestCase:function(a){},addFault:function(a,b){var c=this._10(a),d=c.name,f=c.context;f.child(d).addFault(b.longDisplay())},printSummary:function(a){this._1k.innerHTML='Finished in '+a+' seconds.'},_10:function(c){var d=c.name(),f=c.klass,g=f.getContextName?f.getContextName():f.displayName,h=new JS.Enumerable.Collection();d=d.replace(g,'').replace(g,'').replace(/\(.*?\)$/g,'').replace(/^test\W+/g,'');while(f!==JS.Test.Unit.TestCase){h.push(f);f=f.superclass}g=h.reverseForEach().inject(this._1j,function(a,b){return a.child(b._p||b.displayName)});return{name:d,context:g}}})});JS.Test.Unit.extend({AutoRunner:new JS.Class({extend:{run:function(b){var c=this.getRunner(),d=[],f=[];JS.Test.Unit.TestCase.resolve();JS.Test.Unit.TestCase.forEach(function(a){f.push(a.suite());if(a.superclass===JS.Test.Unit.TestCase)d.push(a.displayName)});var g=new JS.Test.Unit.TestSuite(d.join(', '));for(var h=0,i=f.length;h<i;h++)g.push(f[h]);JS.Test.Unit.TestCase.clear();return c.run(g,this.OUTPUT_LEVELS[b||'normal'])},getRunner:function(){return(typeof window!=='undefined')?this.RUNNERS.browser:this.RUNNERS.console},RUNNERS:{console:JS.Test.Unit.UI.Console.TestRunner,browser:JS.Test.Unit.UI.Browser.TestRunner},OUTPUT_LEVELS:{silent:JS.Test.Unit.UI.SILENT,progress:JS.Test.Unit.UI.PROGRESS_ONLY,normal:JS.Test.Unit.UI.NORMAL,verbose:JS.Test.Unit.UI.VERBOSE}}})});JS.Test.extend({autorun:JS.Test.Unit.AutoRunner.method('run')});JS.Test.extend({Context:new JS.Module({extend:{included:function(a){a.extend(JS.Test.Context.Context,{_e:false});a.include(JS.Test.Context.LifeCycle,{_e:false});a.extend(JS.Test.Context.Test,{_e:false});a.include(JS.Console)},Context:new JS.Module({getContextName:function(){this._p=this._p||'';return(typeof this.superclass.getContextName==='function')?(this.superclass.getContextName()+' '+this._p).replace(/^\s+/,''):this.displayName},setContextName:function(a){this._p=a},context:function(a,b){var c=new JS.Class(this,{},{_e:false});c.__eigen__().resolve();c.setContextName(a.toString());c.setName(c.getContextName());b.call(c);return c},cover:function(a){var b=new JS.Test.Coverage(a);this.before_all_callbacks.push(b.method('attach'));this.after_all_callbacks.push(b.method('detach'));JS.Test.Unit.TestCase.reports.push(b)}})}}),describe:function(a,b){var c=new JS.Class(a.toString(),JS.Test.Unit.TestCase,{},{_e:false});c.include(JS.Test.Context,{_e:false});c.__eigen__().resolve();b.call(c);return c}});JS.Test.Context.Context.alias({describe:'context'});JS.Test.extend({context:JS.Test.describe});JS.Test.Context.LifeCycle=new JS.Module({extend:{included:function(b){b.extend(this.ClassMethods);b.before_all_callbacks=[];b.before_each_callbacks=[];b.after_all_callbacks=[];b.after_each_callbacks=[];b.before_should_callbacks={};b.extend({inherited:function(a){this.callSuper();a.before_all_callbacks=[];a.before_each_callbacks=[];a.after_all_callbacks=[];a.after_each_callbacks=[];a.before_should_callbacks={}}})},ClassMethods:new JS.Module({before:function(a,b){if((typeof a==='function')||!b){b=a;a='each'}this['before_'+(a+'_')+'callbacks'].push(b)},after:function(a,b){if((typeof a==='function')||!b){b=a;a='each'}this['after_'+(a+'_')+'callbacks'].push(b)},gatherCallbacks:function(a,b){var c=(typeof this.superclass.gatherCallbacks==='function')?this.superclass.gatherCallbacks(a,b):[];var d=this[a+'_'+(b+'_')+'callbacks'];return(a==='before')?c.concat(d):d.concat(c)}})},setup:function(a){var b=this;this.callSuper(function(){if(b.klass.before_should_callbacks[b._1])b.klass.before_should_callbacks[b._1].call(b);b.runCallbacks('before','each',a)})},teardown:function(a){var b=this;this.callSuper(function(){b.runCallbacks('after','each',a)})},runCallbacks:function(c,d,f){var g=this.klass.gatherCallbacks(c,d);JS.Test.Unit.TestSuite.forEach(g,function(a,b){this.exec(a,b)},f,this)},runAllCallbacks:function(d,f,g){var h=this.instanceVariables();this.runCallbacks(d,'all',function(){var c=this.instanceVariables().inject({},function(a,b){if(h.member(b))return a;a[b]=this[b];return a},this);if(f)f.call(g||null,c)})},setValuesFromCallbacks:function(a){for(var b in a)this[b]=a[b]},instanceVariables:function(){var a=[];for(var b in this){if(this.hasOwnProperty(b))a.push(b)}return new JS.Enumerable.Collection(a)}});(function(){var a=JS.Test.Context.LifeCycle.ClassMethods.method('instanceMethod');JS.Test.Context.LifeCycle.ClassMethods.include({setup:a('before'),teardown:a('after')})})();JS.Test.Context.extend({SharedBehavior:new JS.Class(JS.Module,{extend:{createFromBehavior:function(a){var b=new this();b._1l=a;return b},moduleName:function(c){return c.toLowerCase().replace(/[\s:',\.~;!#=\(\)&]+/g,'_').replace(/\/(.?)/g,function(a,b){return"."+b.toUpperCase()}).replace(/(?:^|_)(.)/g,function(a,b){return b.toUpperCase()})}},included:function(a){this._1l.call(a)}})});JS.Test.Unit.TestCase.extend({shared:function(a,b){a=JS.Test.Context.SharedBehavior.moduleName(a);JS.ENV[a]=JS.Test.Context.SharedBehavior.createFromBehavior(b)},use:function(a){if(JS.isType(a,JS.Test.Context.SharedBehavior)||JS.isType(a,JS.Module))this.include(a);else if(JS.isType(a,'string')){var b=JS.Test.Context.SharedBehavior.moduleName(a),c=JS.ENV[b];if(!c)throw new Error('Could not find example group named "'+a+'"');this.include(c)}}});(function(){var g=function(a,b){var c={};for(var d=0,f=b.length;d<f;d++)c[b[d]]=JS.Test.Unit.TestCase[a];JS.Test.Unit.TestCase.extend(c)};g('shared',['sharedBehavior','shareAs','shareBehaviorAs','sharedExamplesFor']);g('use',['uses','itShouldBehaveLike','behavesLike','usesExamplesFrom'])})();JS.Test.Context.Test=new JS.Module({test:function(a,b,c){var d='test:',f=this.getContextName();if(f)d+=' '+f;d+=' '+a;if(this.instanceMethod(d))throw new Error(d+' is already defined in '+this.displayName);b=b||{};if(typeof b==='function'){c=b}else{if(b.before!==undefined)this.before_should_callbacks[d]=b.before}this.define(d,c,{_e:false})},beforeTest:function(a,b){this.test(a,{before:b},function(){})}});JS.Test.Context.Test.alias({it:'test',should:'test',tests:'test',beforeIt:'beforeTest',beforeShould:'beforeTest',beforeTests:'beforeTest'});JS.Test.Unit.TestCase.extend({suite:function(){var b=new JS.Enumerable.Collection(this.instanceMethods(false)),c=b.select(function(a){return/^test./.test(a)}).sort(),d=new JS.Test.Unit.TestSuite(this.displayName);for(var f=0,g=c.length;f<g;f++){try{d.push(new this(c[f]))}catch(e){}}return d}});JS.Test.Unit.TestSuite.include({run:function(d,f,g,h){g.call(h||null,this.klass.STARTED,this._m);var i=function(c){this.forEach(function(a,b){if(c)a.setValuesFromCallbacks(c);a.run(d,b,g,h)},function(){var a=function(){g.call(h||null,this.klass.FINISHED,this._m);f()};if(c)j.runAllCallbacks('after',a,this);else a.call(this)},this)};var j=this._3[0],k=null;if(j&&j.runAllCallbacks)j.runAllCallbacks('before',i,this);else i.call(this,null)}});JS.Test.extend({Mocking:new JS.Module({extend:{ExpectationError:new JS.Class(JS.Test.Unit.AssertionFailedError),UnexpectedCallError:new JS.Class(Error,{initialize:function(a){this.message=a.toString()}}),__activeStubs__:[],stub:function(a,b,c){if(JS.isType(a,'string')){c=b;b=a;a=JS.ENV}var d=this.__activeStubs__,f=d.length;while(f--){if(d[f]._7===a&&d[f]._1===b)return d[f].defaultMatcher(c)}var g=new JS.Test.Mocking.Stub(a,b);d.push(g);return g.defaultMatcher(c)},removeStubs:function(){var a=this.__activeStubs__,b=a.length;while(b--)a[b].revoke();this.__activeStubs__=[]},verify:function(){try{var a=this.__activeStubs__;for(var b=0,c=a.length;b<c;b++)a[b]._1m()}finally{this.removeStubs()}},Stub:new JS.Class({initialize:function(a,b){this._7=a;this._1=b;this._I=a[b];this._1n=a.hasOwnProperty?a.hasOwnProperty(b):(typeof this._I!=='undefined');var c=JS.Test.Mocking;this._q=[];this._f=new c.Parameters([new c.AnyArgs()]);this._8=false;this.apply()},defaultMatcher:function(a){if(a!==undefined&&typeof a!=='function'){this._7[this._1]=a;return this}this._11();this._4=this._f;if(typeof a==='function')this._4._12=a;return this},apply:function(){var a=this._7,b=this._1;if(a[b]!==this._I)return;var c=this;a[b]=function(){return c._1o(arguments)}},revoke:function(){if(this._1n)this._7[this._1]=this._I;else try{delete this._7[this._1]}catch(e){this._7[this._1]=undefined}},expected:function(){this._8=true;this._f._8=true},_11:function(){if(this._4)this._4._13=true},_1o:function(a){this._11();var b=this._q.concat(this._f),c,d;this._f.ping();for(var f=0,g=b.length;f<g;f++){c=b[f];d=c.match(a);if(!d)continue;if(c!==this._f)c.ping();if(typeof d==='function')return d.apply(this._7,a);if(d===true)return c.nextReturnValue();if(d.callback)return d.callback.apply(d.context,c.nextYieldArgs());if(d.exception)throw d.exception;}var h=new JS.Test.Unit.AssertionMessage('','<?> received call to '+this._1+'() with unexpected arguments:\n(?)',[this._7,JS.array(a)]);throw new JS.Test.Mocking.UnexpectedCallError(h);},_1m:function(){if(!this._8)return;for(var a=0,b=this._q.length;a<b;a++)this._14(this._q[a]);this._14(this._f)},_14:function(a){a.verify(this._7,this._1)}})}})});JS.Test.Mocking.extend({Parameters:new JS.Class({initialize:function(a,b){this._15=JS.array(a);this._8=b;this._13=false;this._g=0},toArray:function(){var a=this._15.slice();if(this._h)a.push(new JS.Test.Mocking.InstanceOf(Function));return a},returns:function(a){this._J=0;this._K=a},nextReturnValue:function(){if(!this._K)return undefined;var a=this._K[this._J];this._J=(this._J+1)%this._K.length;return a},yields:function(a){this._L=0;this._h=a},nextYieldArgs:function(){if(!this._h)return undefined;var a=this._h[this._L];this._L=(this._L+1)%this._h.length;return a},setMinimum:function(a){this._8=true;this._M=a},setMaximum:function(a){this._8=true;this._r=a},setExpected:function(a){this._8=true;this._N=a},match:function(a){if(!this._13)return false;var b=JS.array(a),c,d;if(this._h){if(typeof b[b.length-2]==='function'){d=b.pop();c=b.pop()}else if(typeof b[b.length-1]==='function'){d=null;c=b.pop()}}if(!JS.Enumerable.areEqual(this._15,b))return false;if(this._k)return{exception:this._k};if(this._h)return{callback:c,context:d};if(this._12)return this._12;else return true},ping:function(){this._g+=1},verify:function(a,b){if(!this._8)return;var c=true,d;if(this._g===0&&!this._r){c=false}else if(this._N&&this._g!==this._N){d=this._O('exactly');c=false}else if(this._r&&this._g>this._r){d=this._O('at most');c=false}else if(this._M&&this._g<this._M){d=this._O('at least');c=false}if(c)return;var f=new JS.Test.Unit.AssertionMessage('Mock expectation not met','<?> expected to receive call\n'+b+'(?)'+(d?'\n'+d:'')+'.',[a,this.toArray()]);throw new JS.Test.Mocking.ExpectationError(f);},_O:function(a){var b=this._g,c='but '+b+' call'+(b===1?' was':'s were')+' made';var d={'exactly':this._N,'at most':this._r,'at least':this._M};return a+' '+d[a]+' times\n'+c}})});JS.Test.Mocking.extend({Anything:new JS.Class({equals:function(){return true},toString:function(){return'anything'}}),AnyArgs:new JS.Class({equals:function(){return JS.Enumerable.ALL_EQUAL},toString:function(){return'*arguments'}}),ArrayIncluding:new JS.Class({initialize:function(a){this._i=Array.prototype.slice.call(a)},equals:function(a){if(!JS.isType(a,Array))return false;var b=this._i.length,c;loop:while(b--){c=a.length;while(c--){if(JS.Enumerable.areEqual(this._i[b],a[c]))continue loop}return false}return true},toString:function(){var a=JS.Console.convert(this._i);return'arrayIncluding('+a+')'}}),ObjectIncluding:new JS.Class({initialize:function(a){this._i=a},equals:function(a){if(!JS.isType(a,Object))return false;for(var b in this._i){if(!JS.Enumerable.areEqual(this._i[b],a[b]))return false}return true},toString:function(){var a=JS.Console.convert(this._1q);return'objectIncluding('+a+')'}}),InstanceOf:new JS.Class({initialize:function(a){this._a=a},equals:function(a){return JS.isType(a,this._a)},toString:function(){var a=JS.Console.convert(this._a),b=/^[aeiou]/i.test(a)?'an':'a';return b+'('+a+')'}}),Matcher:new JS.Class({initialize:function(a){this._a=a},equals:function(a){return JS.match(this._a,a)},toString:function(){var a=JS.Console.convert(this._a);return'matching('+a+')'}})});JS.Test.Mocking.Stub.include({given:function(){var a=new JS.Test.Mocking.Parameters(arguments,this._8);this._q.push(a);this._4=a;return this},raises:function(a){this._4._k=a;return this},returns:function(){this._4.returns(arguments);return this},yields:function(){this._4.yields(arguments);return this},atLeast:function(a){this._4.setMinimum(a);return this},atMost:function(a){this._4.setMaximum(a);return this},exactly:function(a){this._4.setExpected(a);return this}});JS.Test.Mocking.Stub.alias({raising:'raises',returning:'returns',yielding:'yields'});JS.Test.Mocking.extend({DSL:new JS.Module({stub:function(){return JS.Test.Mocking.stub.apply(JS.Test.Mocking,arguments)},expect:function(a,b){var c=JS.Test.Mocking.stub(a,b);c.expected();this.addAssertion();return c},anything:function(){return new JS.Test.Mocking.Anything()},anyArgs:function(){return new JS.Test.Mocking.AnyArgs()},instanceOf:function(a){return new JS.Test.Mocking.InstanceOf(a)},match:function(a){return new JS.Test.Mocking.Matcher(a)},arrayIncluding:function(){return new JS.Test.Mocking.ArrayIncluding(arguments)},objectIncluding:function(a){return new JS.Test.Mocking.ObjectIncluding(a)}})});JS.Test.Unit.TestCase.include(JS.Test.Mocking.DSL);JS.Test.Unit.mocking=JS.Test.Mocking;JS.Test.extend({FakeClock:new JS.Module({extend:{API:{stub:function(){var a=JS.Test.Mocking,b=['Date','setTimeout','clearTimeout','setInterval','clearInterval'],c=b.length;JS.Test.FakeClock.reset();while(c--)a.stub(b[c],JS.Test.FakeClock.method(b[c]))},reset:function(){return JS.Test.FakeClock.reset()},tick:function(a){return JS.Test.FakeClock.tick(a)}},JSDate:Date,Schedule:new JS.Class(JS.SortedSet,{nextScheduledAt:function(b){return this.find(function(a){return a.time<=b})}}),Timeout:new JS.Class({include:JS.Comparable,initialize:function(a,b,c){this.callback=a;this.interval=b;this.repeat=c},compareTo:function(a){return this.time-a.time}}),reset:function(){this._P=new Date().getTime();this._Q=this._P;this._o=new this.Schedule()},tick:function(a){this._P+=a;var b;while(b=this._o.nextScheduledAt(this._P))this._1p(b)},_1p:function(a){this._Q=a.time;a.callback();if(a.repeat){a.time+=a.interval;this._o.rebuild()}else{this.clearTimeout(a)}},_16:function(a,b,c){var d=new this.Timeout(a,b,c);d.time=this._Q+b;this._o.add(d);return d},Date:function(){var a=new this.JSDate();a.setTime(this._Q);return a},setTimeout:function(a,b){return this._16(a,b,false)},setInterval:function(a,b){return this._16(a,b,true)},clearTimeout:function(a){this._o.remove(a)},clearInterval:function(a){this._o.remove(a)}}})});JS.Test.FakeClock.include({clock:JS.Test.FakeClock.API});JS.Test.extend({AsyncSteps:new JS.Class(JS.Module,{define:function(b,c){this.callSuper(b,function(){var a=[b,c].concat(JS.array(arguments));this.__enqueue__(a)})},included:function(a){a.include(JS.Test.AsyncSteps.Sync);if(a.includes(JS.Test.Context))a.after(function(resume){this.sync(resume)})},extend:{Sync:new JS.Module({__enqueue__:function(a){this.__stepQueue__=this.__stepQueue__||[];this.__stepQueue__.push(a);if(this.__runningSteps__)return;this.__runningSteps__=true;JS.ENV.setTimeout(this.method('__runNextStep__'),1)},__runNextStep__:function(){var a=this.__stepQueue__.shift(),b;if(!a){this.__runningSteps__=false;if(!this.__stepCallbacks__)return;while(b=this.__stepCallbacks__.shift())b();return}var c=a.shift(),d=a.shift(),f=a.slice(),g=function(){d.apply(this,f)};f[d.length-1]=this.method('__runNextStep__');if(!this.exec)return g.call(this);this.exec(g,function(){},this.method('__endSteps__'))},__endSteps__:function(){this.__stepQueue__=[];this.__runNextStep__()},sync:function(a){if(!this.__runningSteps__)return a();this.__stepCallbacks__=this.__stepCallbacks__||[];this.__stepCallbacks__.push(a)}})}}),asyncSteps:function(a){return new this.AsyncSteps(a)}});JS.Test.extend({Coverage:new JS.Class({initialize:function(d){this._17=d;this._R=new JS.Hash([]);var f=function(a){var b=a.instanceMethods(false),c=b.length;while(c--)this._R.store(a.instanceMethod(b[c]),0)};f.call(this,d);f.call(this,d.__eigen__())},attach:function(){var a=this._17;JS.StackTrace.addObserver(this);JS.Method.trace([a,a.__eigen__()])},detach:function(){var a=this._17;JS.Method.untrace([a,a.__eigen__()]);JS.StackTrace.removeObserver(this)},update:function(a,b){if(a!=='call')return;var c=this._R.assoc(b.method);if(c)c.setValue(c.value+1)},report:function(){var c=this._R.entries().sort(function(a,b){return b.value-a.value});JS.Console.printTable(c,function(a,b){if(a[1]===0)return['bgred','white'];return(b%2===0)?['bold']:[]})}})});JS.Test.extend({Helpers:new JS.Module({$R:function(a,b){return new JS.Range(a,b)},$w:function(a){return a.split(/\s+/)},forEach:function(a,b,c){for(var d=0,f=a.length;d<f;d++){b.call(c||null,a[d],d)}},its:function(){return new JS.MethodChain()},map:function(a,b,c){return new JS.Enumerable.Collection(a).map(b,c)},repeat:function(a,b,c){while(a--)b.call(c)}})});