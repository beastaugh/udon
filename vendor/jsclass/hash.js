JS.Hash=new JS.Class('Hash',{include:JS.Enumerable||{},extend:{Pair:new JS.Class({include:JS.Comparable||{},length:2,setKey:function(a){this[0]=this.key=a},hasKey:function(a){return JS.Enumerable.areEqual(this.key,a)},setValue:function(a){this[1]=this.value=a},hasValue:function(a){return JS.Enumerable.areEqual(this.value,a)},compareTo:function(a){return this.key.compareTo?this.key.compareTo(a.key):(this.key<a.key?-1:(this.key>a.key?1:0))},hash:function(){var a=JS.Hash.codeFor(this.key),b=JS.Hash.codeFor(this.value);return[a,b].sort().join('/')}}),codeFor:function(a){if(typeof a!=='object')return String(a);return(typeof a.hash==='function')?a.hash():a.toString()}},initialize:function(a){this.clear();if(!JS.isType(a,Array))return this.setDefault(a);for(var b=0,c=a.length;b<c;b+=2)this.store(a[b],a[b+1])},forEach:function(a,b){if(!a)return this.enumFor('forEach');a=JS.Enumerable.toFn(a);var c,d,e;for(c in this._0){if(!this._0.hasOwnProperty(c))continue;d=this._0[c];e=d.length;while(e--)a.call(b||null,d[e])}return this},_7:function(a,b){var c=this.klass.codeFor(a),d=this._0[c];if(!d&&b)d=this._0[c]=[];return d},_8:function(a,b){var c=a.length,d=!!this._5;while(c--){if(d?(a[c].key===b):a[c].hasKey(b))return c}return-1},assoc:function(a,b){var c,d,e;c=this._7(a,b);if(!c)return null;d=this._8(c,a);if(d>-1)return c[d];if(!b)return null;this.size+=1;this.length+=1;e=new this.klass.Pair;e.setKey(a);c.push(e);return e},rassoc:function(a){var b=this.key(a);return b?this.assoc(b):null},clear:function(){this._0={};this.length=this.size=0},compareByIdentity:function(){this._5=true;return this},comparesByIdentity:function(){return!!this._5},setDefault:function(a){this._6=a;return this},getDefault:function(a){return(typeof this._6==='function')?this._6(this,a):(this._6||null)},equals:function(c){if(!JS.isType(c,JS.Hash)||this.length!==c.length)return false;var d=true;this.forEach(function(a){if(!d)return;var b=c.assoc(a.key);if(b===null||!b.hasValue(a.value))d=false});return d},hash:function(){var b=[];this.forEach(function(a){b.push(a.hash())});return b.sort().join('')},fetch:function(a,b,c){var d=this.assoc(a);if(d)return d.value;if(b===undefined)throw new Error('key not found');if(typeof b==='function')return b.call(c||null,a);return b},forEachKey:function(b,c){if(!b)return this.enumFor('forEachKey');b=JS.Enumerable.toFn(b);this.forEach(function(a){b.call(c||null,a.key)});return this},forEachPair:function(b,c){if(!b)return this.enumFor('forEachPair');b=JS.Enumerable.toFn(b);this.forEach(function(a){b.call(c||null,a.key,a.value)});return this},forEachValue:function(b,c){if(!b)return this.enumFor('forEachValue');b=JS.Enumerable.toFn(b);this.forEach(function(a){b.call(c||null,a.value)});return this},get:function(a){var b=this.assoc(a);return b?b.value:this.getDefault(a)},hasKey:function(a){return!!this.assoc(a)},hasValue:function(b){var c=false,d=!!this._5;this.forEach(function(a){if(c)return;if(d?b===a.value:JS.Enumerable.areEqual(b,a.value))c=true});return c},invert:function(){var b=new this.klass;this.forEach(function(a){b.store(a.value,a.key)});return b},isEmpty:function(){for(var a in this._0){if(this._0.hasOwnProperty(a)&&this._0[a].length>0)return false}return true},key:function(b){var c=null;this.forEach(function(a){if(!c&&JS.Enumerable.areEqual(b,a.value))c=a.key});return c},keys:function(){var b=[];this.forEach(function(a){b.push(a.key)});return b},merge:function(a,b,c){var d=new this.klass;d.update(this);d.update(a,b,c);return d},rehash:function(){var a=new this.klass;a._0=this._0;this.clear();this.update(a)},remove:function(a,b){if(b===undefined)b=null;var c,d,e;c=this._7(a);if(!c)return(typeof b==='function')?this.fetch(a,b):this.getDefault(a);d=this._8(c,a);if(d<0)return(typeof b==='function')?this.fetch(a,b):this.getDefault(a);e=c[d].value;this._9(c,d);this.size-=1;this.length-=1;if(c.length===0)delete this._0[this.klass.codeFor(a)];return e},_9:function(a,b){a.splice(b,1)},removeIf:function(b,c){if(!b)return this.enumFor('removeIf');b=JS.Enumerable.toFn(b);var d=[];this.forEach(function(a){if(b.call(c||null,a))d.push(a.key)},this);var e=d.length;while(e--)this.remove(d[e]);return this},replace:function(a){this.clear();this.update(a)},shift:function(){var a=this.keys();if(a.length===0)return this.getDefault();var b=this.assoc(a[0]);this.remove(b.key);return b},store:function(a,b){this.assoc(a,true).setValue(b);return b},toString:function(){return'Hash:{'+this.map(function(a){return a.key.toString()+'=>'+a.value.toString()}).join(',')+'}'},update:function(d,e,f){var g=(typeof e==='function');d.forEach(function(a){var b=a.key,c=a.value;if(g&&this.hasKey(b))c=e.call(f||null,b,this.get(b),c);this.store(b,c)},this)},values:function(){var b=[];this.forEach(function(a){b.push(a.value)});return b},valuesAt:function(){var a=arguments.length,b=[];while(a--)b.push(this.get(arguments[a]));return b}});JS.Hash.alias({includes:'hasKey',index:'key',put:'store'});JS.OrderedHash=new JS.Class('OrderedHash',JS.Hash,{assoc:function(a,b){var c=JS.Hash.prototype.assoc;var d=c.call(this,a,false);if(d||!b)return d;var e=c.call(this,a,true);if(!this._2){this._2=this._3=e}else{this._3._1=e;e._4=this._3;this._3=e}return e},clear:function(){this.callSuper();this._2=this._3=null},_9:function(a,b){var c=a[b];if(c._4)c._4._1=c._1;if(c._1)c._1._4=c._4;if(c===this._2)this._2=c._1;if(c===this._3)this._3=c._4;return this.callSuper()},forEach:function(a,b){if(!a)return this.enumFor('forEach');a=JS.Enumerable.toFn(a);var c=this._2;while(c){a.call(b||null,c);c=c._1}},rehash:function(){var a=this._2;this.clear();while(a){this.store(a.key,a.value);a=a._1}}});