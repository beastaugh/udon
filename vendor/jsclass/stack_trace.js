JS.StackTrace=new JS.Module('StackTrace',{extend:{logger:new JS.Singleton({include:JS.Console,active:false,update:function(a,b){if(!this.active)return;switch(a){case'call':return this.logEnter(b);case'return':return this.logExit(b);case'error':return this.logError(b)}},indent:function(){var a=' ';JS.StackTrace.forEach(function(){a+='|  '});return a},fullName:function(a){var b=JS.Console,f=a.method,g=a.env,d=f.name,c=f.module;return b.nameOf(g)+(c===g?'':'('+b.nameOf(c)+')')+'#'+d},logEnter:function(a){var b=this.fullName(a),f=JS.Console.convert(a.args).replace(/^\[/,'(').replace(/\]$/,')');if(this._0)this.puts();this.reset();this.print(' ');this.consoleFormat('bgblack','white');this.print('TRACE');this.reset();this.print(this.indent());this.blue();this.print(b);this.red();this.print(f);this.reset();this._0=true},logExit:function(a){var b=this.fullName(a);if(a.leaf){this.consoleFormat('red');this.print(' --> ')}else{this.reset();this.print(' ');this.consoleFormat('bgblack','white');this.print('TRACE');this.reset();this.print(this.indent());this.blue();this.print(b);this.red();this.print(' --> ')}this.consoleFormat('yellow');this.puts(JS.Console.convert(a.result));this.reset();this.print('');this._0=false},logError:function(a){this.puts();this.reset();this.print(' ');this.consoleFormat('bgred','white');this.print('ERROR');this.consoleFormat('bold','red');this.print(' '+JS.Console.convert(a));this.reset();this.print(' thrown by ');this.bold();this.print(JS.StackTrace.top().name);this.reset();this.puts('. Backtrace:');this.backtrace()},backtrace:function(){JS.StackTrace.reverseForEach(function(a){var b=JS.Console.convert(a.args).replace(/^\[/,'(').replace(/\]$/,')');this.print('      | ');this.consoleFormat('blue');this.print(a.name);this.red();this.print(b);this.reset();this.puts(' in ');this.print('      |  ');this.bold();this.puts(JS.Console.convert(a.object))},this);this.reset();this.puts()}}),include:[JS.Observable,JS.Enumerable],wrap:function(b,f,g){var d=JS.StackTrace;var c=function(){var a;d.push(this,f,g,Array.prototype.slice.call(arguments));try{a=b.apply(this,arguments)}catch(e){d.error(e)}d.pop(a);return a};c.toString=function(){return b.toString()};c.__traced__=true;return c},stack:[],forEach:function(a,b){JS.Enumerable.forEach.call(this.stack,a,b)},top:function(){return this.stack[this.stack.length-1]||{}},push:function(a,b,f,g){var d=this.stack;if(d.length>0)d[d.length-1].leaf=false;var c={object:a,method:b,env:f,args:g,leaf:true};c.name=this.logger.fullName(c);this.notifyObservers('call',c);d.push(c)},pop:function(a){var b=this.stack.pop();b.result=a;this.notifyObservers('return',b)},error:function(a){if(a.logged)throw a;a.logged=true;this.notifyObservers('error',a);this.stack=[];throw a;}}});JS.StackTrace.addObserver(JS.StackTrace.logger);
//@ sourceMappingURL=stack_trace.js.map